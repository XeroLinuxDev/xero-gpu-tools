#!/usr/bin/env bash

FLAG="/var/lib/xero-gpu/changed"
LOCKFILE="/tmp/xero-gpu-notify.lock"

# Prevent double execution
if [[ -e "$LOCKFILE" ]]; then
    exit 0
fi
touch "$LOCKFILE"

# Only run inside a KDE Plasma session
if ! qdbus org.kde.KWin /KWin org.kde.KWin.supportInformation &>/dev/null; then
    rm -f "$LOCKFILE"
    exit 0
fi

# Only proceed if GUI exists
if [[ -z "${DISPLAY:-}" && -z "${WAYLAND_DISPLAY:-}" ]]; then
    rm -f "$LOCKFILE"
    exit 0
fi

# Nothing changed â†’ exit
if [[ ! -f "$FLAG" ]]; then
    rm -f "$LOCKFILE"
    exit 0
fi

# Clear change flag so it doesn't spam
rm -f "$FLAG"

# Show dialog
/usr/bin/kdialog --yesno "XeroLinux detected a GPU hardware change.

Do you want to run the GPU configuration tool now?" \
--title "GPU Change Detected"

if [[ $? -eq 0 ]]; then
    /usr/bin/konsole -e bash -c "/usr/bin/sudo /usr/bin/xero-gpu-config; echo 'Press Enter to close'; read"
fi

rm -f "$LOCKFILE"
