#!/usr/bin/env bash
#
# xero-gpu-config
# XeroLinux GPU Stack Installer & Cleaner
#

set -euo pipefail

# -----------------------------------------------------
# Colors
# -----------------------------------------------------
RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
BLUE="\033[34m"
MAGENTA="\033[35m"
CYAN="\033[36m"
BOLD="\033[1m"
RESET="\033[0m"

# -----------------------------------------------------
# Auto-elevate via sudo
# -----------------------------------------------------
if (( EUID != 0 )); then
    exec sudo "$0" "$@"
fi

LOGFILE="/var/log/xero-gpu-config.log"

log() {
    echo -e "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOGFILE"
}

pause_confirm() {
    local prompt="$1"
    echo
    read -r -p "$(echo -e "${YELLOW}${prompt}${RESET} [y/N]: ")" answer
    case "$answer" in
        [Yy]*) return 0 ;;
        *)     return 1 ;;
    esac
}

# -----------------------------------------------------
# Banner
# -----------------------------------------------------
clear
echo -e "${CYAN}"
echo "──────────────────────────────────────────"
echo "     XeroLinux GPU Configuration Utility"
echo "──────────────────────────────────────────"
echo -e "${RESET}"
sleep 0.2

echo -e "${MAGENTA}Log file: $LOGFILE${RESET}"
echo

# -----------------------------------------------------
# GPU detection
# -----------------------------------------------------

HAS_INTEL=0
HAS_AMD=0
HAS_NVIDIA=0

detect_gpus() {
    local gpuinfo
    gpuinfo="$(lspci -nnk | grep -E 'VGA|3D|Display' || true)"

    echo -e "${BLUE}Detecting GPUs...${RESET}"
    sleep 0.3

    if echo "$gpuinfo" | grep -qi "Intel"; then
        HAS_INTEL=1
    fi
    if echo "$gpuinfo" | grep -qi "AMD\|ATI"; then
        HAS_AMD=1
    fi
    if echo "$gpuinfo" | grep -qi "NVIDIA"; then
        HAS_NVIDIA=1
    fi

    echo -e "${GREEN}Detected:${RESET}"
    [[ $HAS_INTEL -eq 1 ]] && echo " • Intel GPU"
    [[ $HAS_AMD -eq 1 ]] && echo " • AMD GPU"
    [[ $HAS_NVIDIA -eq 1 ]] && echo " • NVIDIA GPU"
    echo

    log "GPU Info:"
    log "$gpuinfo"
}

# -----------------------------------------------------
# NVIDIA package set
# -----------------------------------------------------
NVIDIA_PKGS=(
    libvdpau
    nvidia-utils
    opencl-nvidia
    nvidia-settings
    nvidia-open-dkms
    lib32-nvidia-utils
    lib32-opencl-nvidia
    linux-firmware-nvidia
)

nvidia_installed() {
    for pkg in "${NVIDIA_PKGS[@]}"; do
        if pacman -Qq "$pkg" &>/dev/null; then
            return 0
        fi
    done
    return 1
}

# -----------------------------------------------------
# mkinitcpio helpers
# -----------------------------------------------------
ensure_nvidia_modules_in_mkinitcpio() {
    local conf="/etc/mkinitcpio.conf"
    echo -e "${BLUE}Injecting NVIDIA modules into mkinitcpio.conf...${RESET}"

    sed -i '/^MODULES=/ s/(/(nvidia nvidia_modeset nvidia_uvm nvidia_drm /' "$conf"
}

remove_nvidia_modules_from_mkinitcpio() {
    local conf="/etc/mkinitcpio.conf"
    echo -e "${YELLOW}Removing NVIDIA modules from mkinitcpio.conf...${RESET}"

    sed -i 's/nvidia_drm //g; s/nvidia_uvm //g; s/nvidia_modeset //g; s/nvidia //g' "$conf"
}

# -----------------------------------------------------
# GRUB helpers
# -----------------------------------------------------
grub_exists() {
    [[ -f /etc/default/grub ]]
}

get_grub_cmdline() {
    grep '^GRUB_CMDLINE_LINUX_DEFAULT=' /etc/default/grub | sed 's/^GRUB_CMDLINE_LINUX_DEFAULT="//; s/"$//'
}

set_grub_cmdline() {
    sed -i "s|^GRUB_CMDLINE_LINUX_DEFAULT=\".*\"|GRUB_CMDLINE_LINUX_DEFAULT=\"$1\"|" /etc/default/grub
}

ensure_kernel_param() {
    local current="$1"
    local param="$2"
    if grep -qw "$param" <<< "$current"; then
        echo "$current"
    else
        echo "$current $param"
    fi
}

configure_grub_for_nvidia() {
    echo -e "${BLUE}Configuring GRUB for NVIDIA...${RESET}"
    local current new

    current="$(get_grub_cmdline)"

    new="$current"
    new="$(ensure_kernel_param "$new" "nvidia_drm.modeset=1")"
    new="$(ensure_kernel_param "$new" "modprobe.blacklist=nouveau")"
    new="$(ensure_kernel_param "$new" "nouveau.modeset=0")"

    set_grub_cmdline "$new"
}

cleanup_grub_for_no_nvidia() {
    echo -e "${YELLOW}Cleaning up GRUB NVIDIA flags...${RESET}"
    local current new

    current="$(get_grub_cmdline)"
    new="$current"

    new="$(echo "$new" | sed -E "s/(^| )nvidia_drm.modeset=1( |$)/ /g")"
    new="$(echo "$new" | sed -E "s/(^| )modprobe\.blacklist=nouveau( |$)/ /g")"
    new="$(echo "$new" | sed -E "s/(^| )nouveau.modeset=0( |$)/ /g")"

    set_grub_cmdline "$new"
}

regenerate_grub() {
    if [[ -x /usr/bin/grub-mkconfig ]] && [[ -d /boot/grub ]]; then
        echo -e "${BLUE}Regenerating GRUB config...${RESET}"
        grub-mkconfig -o /boot/grub/grub.cfg | tee -a "$LOGFILE"
    fi
}

# -----------------------------------------------------
# NVIDIA actions
# -----------------------------------------------------
install_nvidia_stack() {
    echo -e "${GREEN}${BOLD}Installing NVIDIA driver stack...${RESET}"
    pacman -Sy --needed --noconfirm "${NVIDIA_PKGS[@]}"

    ensure_nvidia_modules_in_mkinitcpio
    configure_grub_for_nvidia

    echo -e "${CYAN}Rebuilding initramfs...${RESET}"
    mkinitcpio -P | tee -a "$LOGFILE"

    regenerate_grub

    echo -e "${GREEN}${BOLD}NVIDIA installation complete!${RESET}"
}

remove_nvidia_stack() {
    echo -e "${YELLOW}${BOLD}Removing NVIDIA drivers...${RESET}"

    for pkg in "${NVIDIA_PKGS[@]}"; do
        if pacman -Qq "$pkg" &>/dev/null; then
            echo -e "${YELLOW}Removing $pkg...${RESET}"
            pacman -Rdd --noconfirm "$pkg" || true
        fi
    done

    remove_nvidia_modules_from_mkinitcpio
    cleanup_grub_for_no_nvidia

    echo -e "${CYAN}Rebuilding initramfs...${RESET}"
    mkinitcpio -P | tee -a "$LOGFILE"

    regenerate_grub

    echo -e "${GREEN}${BOLD}NVIDIA removal complete!${RESET}"
}

# -----------------------------------------------------
# Main logic
# -----------------------------------------------------
main() {
    mkdir -p "$(dirname "$LOGFILE")"
    log "===== xero-gpu-config started ====="

    detect_gpus

    if (( HAS_NVIDIA == 1 )); then
        echo -e "${GREEN}${BOLD}NVIDIA GPU detected.${RESET}"

        if nvidia_installed; then
            if pause_confirm "NVIDIA stack already installed. Reapply configuration?"; then
                install_nvidia_stack
            fi
        else
            echo -e "${YELLOW}NVIDIA GPU found but drivers are missing.${RESET}"
            if pause_confirm "Install full NVIDIA stack now?"; then
                install_nvidia_stack
            fi
        fi

    else
        echo -e "${RED}${BOLD}No NVIDIA GPU detected.${RESET}"

        if nvidia_installed; then
            if pause_confirm "Remove installed NVIDIA drivers?"; then
                remove_nvidia_stack
            fi
        else
            echo -e "${BLUE}Nothing to do.${RESET}"
        fi
    fi

    log "===== xero-gpu-config finished ====="
}

main "$@"
