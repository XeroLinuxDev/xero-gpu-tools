#!/usr/bin/env bash
#
# XeroLinux GPU Stack Manager
# Hardware-driven, hybrid-safe, ISO-agnostic GPU installer/remover
#

set -euo pipefail

# -----------------------------------------------------
# Auto-elevate via sudo
# -----------------------------------------------------
if (( EUID != 0 )); then
    exec sudo "$0" "$@"
fi

# -----------------------------------------------------
# Colors
# -----------------------------------------------------
RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
BLUE="\033[34m"
MAGENTA="\033[35m"
CYAN="\033[36m"
BOLD="\033[1m"
RESET="\033[0m"

LOGFILE="/var/log/xero-gpu-config.log"
ANY_CHANGES=0

log() {
    echo -e "[$(date +'%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOGFILE"
}

pause_confirm() {
    local msg="$1"
    echo
    read -r -p "$(echo -e "${YELLOW}${msg}${RESET} [y/N]: ")" ans
    [[ $ans =~ ^[Yy]$ ]]
}

# -----------------------------------------------------
# Header
# -----------------------------------------------------
clear
echo -e "${CYAN}${BOLD}"
echo "─────────────────────────────────────────────"
echo "     XeroLinux GPU Automatic Configurator"
echo "─────────────────────────────────────────────"
echo -e "${RESET}"

log "===== GPU CONFIG START ====="

# -----------------------------------------------------
# GPU Detection
# -----------------------------------------------------
HAS_INTEL=0
HAS_AMD=0
HAS_NVIDIA=0

gpuinfo="$(lspci -nnk | grep -E 'VGA|3D|Display' || true)"

echo -e "${BLUE}Detecting GPUs...${RESET}"
sleep 0.2

if echo "$gpuinfo" | grep -qi "Intel"; then HAS_INTEL=1; fi
if echo "$gpuinfo" | grep -qi "AMD\|ATI"; then HAS_AMD=1; fi
if echo "$gpuinfo" | grep -qi "NVIDIA"; then HAS_NVIDIA=1; fi

echo -e "${GREEN}Detected:${RESET}"
[[ $HAS_INTEL == 1 ]] && echo " • Intel GPU"
[[ $HAS_AMD == 1 ]]   && echo " • AMD GPU"
[[ $HAS_NVIDIA == 1 ]] && echo " • NVIDIA GPU"
[[ $HAS_INTEL == 0 && $HAS_AMD == 0 && $HAS_NVIDIA == 0 ]] && echo " • No GPU detected (VM/headless)"

log "$gpuinfo"


# -----------------------------------------------------
# Meta packages
# -----------------------------------------------------
INTEL_META="intel-drv"
AMD_META="amd-drv"

intel_installed() { pacman -Qq "$INTEL_META" &>/dev/null; }
amd_installed() { pacman -Qq "$AMD_META" &>/dev/null; }

# NVIDIA full package set:
NVIDIA_PKGS=(
    libvdpau
    nvidia-utils
    opencl-nvidia
    nvidia-settings
    nvidia-open-dkms
    lib32-nvidia-utils
    lib32-opencl-nvidia
    linux-firmware-nvidia
)

nvidia_installed() {
    for p in "${NVIDIA_PKGS[@]}"; do
        pacman -Qq "$p" &>/dev/null && return 0
    done
    return 1
}

# -----------------------------------------------------
# mkinitcpio
# -----------------------------------------------------
add_nvidia_mkinit() {
    if ! grep -q "nvidia nvidia_modeset nvidia_uvm nvidia_drm" /etc/mkinitcpio.conf; then
        sed -i '/^MODULES=/ s/(/(nvidia nvidia_modeset nvidia_uvm nvidia_drm /' /etc/mkinitcpio.conf
        ANY_CHANGES=1
    fi
}

remove_nvidia_mkinit() {
    sed -i 's/nvidia_drm//g; s/nvidia_uvm//g; s/nvidia_modeset//g; s/nvidia//g' /etc/mkinitcpio.conf
    ANY_CHANGES=1
}

# -----------------------------------------------------
# GRUB handling
# -----------------------------------------------------
GRUB_CONF="/etc/default/grub"

get_cmdline() {
    grep '^GRUB_CMDLINE_LINUX_DEFAULT=' "$GRUB_CONF" | sed 's/GRUB_CMDLINE_LINUX_DEFAULT="//; s/"$//'
}

set_cmdline() {
    sed -i "s|^GRUB_CMDLINE_LINUX_DEFAULT=.*|GRUB_CMDLINE_LINUX_DEFAULT=\"$1\"|" "$GRUB_CONF"
}

add_param() {
    grep -qw "$2" <<< "$1" || echo "$1 $2"
}

remove_param() {
    echo "$1" | sed -E "s/(^| )$2( |$)/ /g" | tr -s ' '
}

configure_grub_nvidia() {
    local current new
    current="$(get_cmdline)"
    new="$current"
    new=$(add_param "$new" "nvidia_drm.modeset=1")
    new=$(add_param "$new" "nouveau.modeset=0")
    new=$(add_param "$new" "modprobe.blacklist=nouveau")
    set_cmdline "$new"
    ANY_CHANGES=1
}

clean_grub_nvidia() {
    local current new
    current="$(get_cmdline)"
    new="$current"
    new=$(remove_param "$new" "nvidia_drm.modeset=1")
    new=$(remove_param "$new" "nouveau.modeset=0")
    new=$(remove_param "$new" "modprobe.blacklist=nouveau")
    set_cmdline "$new"
    ANY_CHANGES=1
}

# -----------------------------------------------------
# Install/Remove driver stacks
# -----------------------------------------------------
install_nvidia() {
    echo -e "${GREEN}${BOLD}Installing NVIDIA stack...${RESET}"
    pacman -Sy --needed --noconfirm "${NVIDIA_PKGS[@]}"
    add_nvidia_mkinit
    configure_grub_nvidia
    ANY_CHANGES=1
}

remove_nvidia() {
    echo -e "${YELLOW}${BOLD}Removing NVIDIA stack...${RESET}"
    for p in "${NVIDIA_PKGS[@]}"; do
        pacman -Rdd --noconfirm "$p" &>/dev/null || true
    done
    remove_nvidia_mkinit
    clean_grub_nvidia
    ANY_CHANGES=1
}

install_intel() {
    if ! intel_installed; then
        pacman -Sy --needed --noconfirm "$INTEL_META"
        ANY_CHANGES=1
    fi
}

remove_intel() {
    if intel_installed; then
        pacman -Rns --noconfirm "$INTEL_META" || true
        ANY_CHANGES=1
    fi
}

install_amd() {
    if ! amd_installed; then
        pacman -Sy --needed --noconfirm "$AMD_META"
        ANY_CHANGES=1
    fi
}

remove_amd() {
    if amd_installed; then
        pacman -Rns --noconfirm "$AMD_META" || true
        ANY_CHANGES=1
    fi
}

# -----------------------------------------------------
# MASTER LOGIC — Based ONLY on hardware detection
# -----------------------------------------------------

###
# CASE A — NVIDIA GPU detected
###
if (( HAS_NVIDIA == 1 )); then
    echo -e "${GREEN}${BOLD}NVIDIA GPU detected.${RESET}"

    # Install NVIDIA stack if missing
    if ! nvidia_installed; then
        if pause_confirm "Install full NVIDIA driver stack?"; then
            install_nvidia
        fi
    else
        echo -e "${BLUE}NVIDIA drivers already installed.${RESET}"
        if pause_confirm "Reapply NVIDIA boot configuration?"; then
            add_nvidia_mkinit
            configure_grub_nvidia
            ANY_CHANGES=1
        fi
    fi

    # Intel/AMD logic (hybrid aware)
    if (( HAS_INTEL == 1 )); then install_intel; else remove_intel; fi
    if (( HAS_AMD == 1 ));   then install_amd;   else remove_amd;   fi

###
# CASE B — No NVIDIA GPU detected
###
else
    echo -e "${RED}${BOLD}No NVIDIA GPU detected.${RESET}"

    # Remove NVIDIA stack if installed
    if nvidia_installed; then
        if pause_confirm "Remove NVIDIA drivers and clean boot configuration?"; then
            remove_nvidia
        fi
    fi

    # If Intel GPU → install intel-drv, remove amd-drv
    if (( HAS_INTEL == 1 && HAS_AMD == 0 )); then
        install_intel
        remove_amd
    fi

    # If AMD GPU → install amd-drv, remove intel-drv
    if (( HAS_AMD == 1 && HAS_INTEL == 0 )); then
        install_amd
        remove_intel
    fi

    # Hybrid Intel + AMD → keep both
    if (( HAS_INTEL == 1 && HAS_AMD == 1 )); then
        install_intel
        install_amd
    fi

    # No GPUs → remove both
    if (( HAS_INTEL == 0 && HAS_AMD == 0 )); then
        remove_intel
        remove_amd
    fi
fi


# -----------------------------------------------------
# Apply mkinitcpio + GRUB updates
# -----------------------------------------------------
if (( ANY_CHANGES == 1 )); then
    echo -e "${CYAN}Rebuilding initramfs...${RESET}"
    mkinitcpio -P | tee -a "$LOGFILE"

    if [[ -d /boot/grub && -x /usr/bin/grub-mkconfig ]]; then
        grub-mkconfig -o /boot/grub/grub.cfg | tee -a "$LOGFILE"
    fi

    echo -e "${GREEN}${BOLD}GPU configuration updated successfully.${RESET}"
else
    echo -e "${BLUE}No GPU configuration changes required.${RESET}"
fi

log "===== GPU CONFIG END ====="
exit 0
